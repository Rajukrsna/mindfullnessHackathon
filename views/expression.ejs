<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="/public/styles/style.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">



<style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #eef2f7;
      color: #333;
    }
    .emotion-card {
      animation: fadeIn 1s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .meditation-section {
      margin-top: 20px;
      animation: slideIn 1s ease-in-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .loading-spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1050;
    }
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
  </style>
<body>

<div class= "container">

<div class="text-center mb-5">
    <h1 class="display-4 fw-bold text-primary">Welcome to Serenity</h1>
    <p class="lead text-muted">Discover your inner calm and let us guide you toward peace and mindfulness. üßò</p>
    <img src="/public/images/med.png" alt="Meditation" class="img-fluid rounded shadow" style="max-height: 400px;">
</div>
<div class="row">
    <div class="col-md-6">

        <div class="card shadow-lg border-0 mx-auto" style="max-width: 600px; background: #f7f9fc;">
            <div class="card-body p-4">
                <h3 class="card-title text-center text-primary mb-3">Analyze Your Mood</h3>
                <p class="text-center text-muted">Upload your photo to let our AI detect your emotions and guide you to tranquility.</p>
                <form  id="problemForm" action="/facialExpression/analyze" method="POST" enctype="multipart/form-data">
                    <div class="mb-4">
                        <label for="image" class="form-label fw-bold text-muted">Upload Your Photo</label>
                        <input type="file" id="image" name="image" class="form-control form-control-lg shadow-sm" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg w-100 shadow-sm">Analyze Mood üßò‚Äç‚ôÇÔ∏è</button>
                </form>
            </div>
        </div>

       </div>
       <div class="col-md-6">
        <div class="card shadow-lg" id="emotionCardContainer">

<!-- Loading Spinner -->
<div class="loading-spinner">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
        </div>
        </div>

        <div id="meditationSection"></div>
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
             
</div>
</div>
<script>
document.getElementById("problemForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const formData = new FormData(this);
    const loadingSpinner = document.querySelector(".loading-spinner");

// Show the loading spinner
loadingSpinner.style.display = "block";
    // Send AJAX request to backend
    fetch('/facialExpression/analyze', {
        method: 'POST',
        body: formData
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const emotionCardContainer = document.getElementById("emotionCardContainer");
            let emotion = data.output.mood;

            emotionCardContainer.innerHTML = `
                <div class="card emotion-card shadow-lg border-0 mx-auto" style="max-width: 600px; background: #f7f9fc;">
                    <div class="card-body p-4">
                        <h3 class="card-title text-center text-primary mb-3">Detected Emotion: ${emotion}</h3>
                        <p class="text-muted">Expressions: ${JSON.stringify(data.output.expressions)}</p>
                        <button id="getMeditationBtn" class="btn btn-success btn-lg w-100 shadow-sm">Get Meditation</button>
                    </div>
                </div>
            `;

            // Attach click listener to the button after it's created
            document.getElementById("getMeditationBtn").addEventListener("click", function () {
                const meditationSection = document.getElementById("meditationSection");

                // Send AJAX request to backend
                fetch('/medRecommend/medRecommend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mood: emotion }) // Send emotion as JSON payload
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(data => {
                        console.log(data)
                        const responseObject = JSON.parse(data);
        const accumulatedDelta = responseObject.accumulatedDelta;
console.log("accumulatedData", accumulatedDelta)
        const cleanedData = accumulatedDelta
          .replace(/```/g, '')  // Remove any backticks
          .trim();  // Remove leading/trailing whitespace

        const parsedData = JSON.parse(cleanedData);
        console.log(parsedData);
        meditationSection.innerHTML = `
    <div class="meditation-section container">
        <h2 class="text-center text-primary mb-4">Meditation Practices</h2>
        <div class="row">
            ${
                parsedData.practices?.map(practice => `
                    <div class="col-md-4">
                        <div class="card shadow-lg border-0 mb-4">
                            <div class="card-body">
                                <h4 class="card-title text-primary">${practice.name}</h4>
                                <p class="text-muted">${practice.description}</p>
                                <p><strong>Benefits:</strong> ${practice.benefits.join(', ')}</p>
                                <button class="btn btn-primary shadow-sm">Start Practice</button>
                            </div>
                        </div>
                    </div>
                `).join('') || '<p>No meditation practices available.</p>'
            }
        </div>
    </div>
`;

                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while fetching meditation recommendations. Please try again.');
                    });
            });
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred during analysis. Please try again.');
        });
});

   
</script>

</body>